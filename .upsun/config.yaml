# Upsun configuration, generated using AI at: 2025-12-01T00:39:34Z
# AI can make mistakes. Please modify this file to suit your needs.
applications:
  backend:
    type: nodejs:24
    source:
      root: backend
    build:
      flavor: none
    mounts:
      'data':
        source: storage
        source_path: backend/data
    hooks:
      build: |
        set -ex
        npm install --omit=dev
        # Run initial database sync if database is empty
        node scripts/sync-db.js || echo "Database sync failed, will retry at runtime"
    web:
      commands:
        start: npm start
      locations:
        /:
          passthru: true

  frontend:
    type: nodejs:24
    source:
      root: frontend
    build:
      flavor: none
    variables:
      env:
        VITE_API_URL: ''
    hooks:
      build: |
        set -ex
        npm install
        npm run build
    web:
      commands:
        start: sleep infinity
      locations:
        /:
          root: dist
          index: [index.html]
          scripts: false
          allow: true
          expires: 24h
          rules:
            '\.(css|js|gif|jpe?g|png|svg|webp)$':
              allow: true
              expires: 4w

services:
  # No external services detected or required based on project files and dependencies

routes:
  https://{default}/api:
    type: upstream
    upstream: backend:http
  https://{default}/health:
    type: upstream
    upstream: backend:http
  https://{default}/:
    type: upstream
    upstream: frontend:http
